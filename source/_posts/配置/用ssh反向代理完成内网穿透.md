---
title: 用ssh反向代理完成内网穿透
date: 2021-05-13 12:15:10
tags: 网络
categories: 配置
description: 用ssh反向代理完成内网穿透和root权限脚本的开机自启。
---

## 内网穿透和反向代理

想要从外网访问内网的服务器时，需要做内网穿透。反向代理是一种进行内网穿透的方法。

反向代理要求有一台公网的服务器来做代理，通俗地讲就是跳板。记内网服务器为T，公网服务器为O。T向O发起ssh反向代理请求，而后T和O就会建立ssh链接，O可以通过自身的反向代理端口访问T的ssh端口，然后O再把来自用户的ssh请求转发到反向代理端口，就可以让用户ssh链接到T了。

简单来说，由于内网是外网访问不到的，就在内网中主动向外网的服务器建立一个稳定的链接，然后外网的其他用户就可以通过这个外网的服务器访问内网了。

## ssh反向代理和端口转发配置

### 反向代理

直接进行配置，在内网服务器上，向公网服务器发起反向代理请求:

```
ssh -fCNR 7280:localhost:22 root@remot_ip
```

R选项：通过绑定远程主机上的地址和端口(port)，将该端口上收到的数据转发到host+hostport指定的端口上。

这条命令让远程服务器把7280端口的ssh链接转发到本地22端口。

ssh链接有时候会断，为了保证链接稳定，需要使用`autossh`:

```
sudo apt install autossh
autossh -M 7281 ssh -fCNR 7280:localhost:22 root@remot_ip
```

后一句命令指定了在远程主机上使用7281端口来监控、维持后面的ssh链接。

这时可以通过netstat命令来查看链接是否正常:

```
netstat -tnlp
```

如果7280和7281端口在监听状态，就没有问题。

也可以在公网服务器上尝试链接内网服务器来确认这一步正确:

```
ssh username@localhost -p 7280
```

### 端口转发

用户不能直接通过公网服务器的7280端口去链接内网的服务器，需要另外指定一个端口，公网服务器将该端口的ssh链接转发到7280端口即可让用户链接到内网服务器，所以在公网服务器可以执行如下命令来做端口转发:

```
ssh -fCNL *:1234:localhost:7280 localhost
```

表示将本地1234端口的ssh链接转发到7280端口。

### 进行远程连接

最后，用户可以直接ssh公网服务器的1234端口，从而连接到内网服务器:

```
ssh username@remote_ip -p 1234
```

## 开机自启

2021.5.17 更新 注意注意:可能因为开机时没有网络，所以`autossh`脚本会运行失败，**会导致启动失败**，整个系统就启动不了。我在自己的机子上发现启动失败才发现。这也有可能是最近服务器重启的时候老是失败的原因...需要用启动盘去挂载`/`然后把启动脚本删了。所以还是**别搞启动脚本**了。

挂载`/`:

````sh
sudo mount /dev/xxx ~/r
````

要搞启动脚本的话估计用frp做内网穿透是一个更好的办法，现在懒得改了(正常情况下服务器不会重启，暂时没这个需求了)。

以下是开机自启脚本配置方法原文，服务器上慎重使用：

反向代理命令开机自启，不然内网服务器一重启就连不上了。

把`autossh`命令写进一个脚本`autossh.sh`，然后放入`/etc/profile.d`文件夹下，给予执行权限。注意需要用root用户创建这个脚本，否则启动时可能没有足够的执行权限:

```
cd /etc/profile.d
sudo su
vim autossh.sh
# 添加autossh命令
sudo chmod +x autossh.sh
```

按理说这样配置之后开机自启应该没问题了，但是我重启之后这条命令虽然被执行了，但是没有效果，必须kill掉这条命令然后手动重新执行才可以，找不到原因。

## 参考链接

[使用SSH反向代理和端口转发](https://www.jianshu.com/p/dafbbbe4c43b)

[Linux以root权限开机自动运行脚本](https://blog.csdn.net/weixin_40429823/article/details/99006940)

